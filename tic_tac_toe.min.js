(()=>{function a(e,i,n){let r=document.createElement(e),d=u=>{u instanceof Node?r.appendChild(u):typeof u=="string"&&r.append(document.createTextNode(u))};return Array.isArray(i)?i.map(d):d(i),n&&n.split(" ").forEach(u=>r.classList.add(u)),r}function A({board:e,moveCallback:i}){let n=r=>{let d=e[r],u=d>0&&d<=2,t=a("div","",u?d==1?"circle":"cross":void 0);return!u&&i&&(t.onclick=()=>i(r)),t};return a("div",[a("div",[n(0),n(1),n(2)]),a("div",[n(3),n(4),n(5)]),a("div",[n(6),n(7),n(8)])],i?"board myturn":"board")}function P(e){let i=e.player1.email==m.email,n=e.player2.email==m.email;switch(e.state){case o.PLAYER1_TURN:return i?"Your turn":["waiting for ",a("span",e.player1.name,"user circle"),"'s turn..."];case o.PLAYER2_TURN:return n?"Your turn":["waiting for ",a("span",e.player2.name,"user cross"),"'s turn..."];case o.TIE:return"game is over, Tie";case o.PLAYER1_WON:return["game is over, ",a("span",e.player1.name,"user circle"),"won"];case o.PLAYER2_WON:return["game is over, ",a("span",e.player2.name,"user cross"),"won"];default:return"unknown game state: "+e.state}}function G(e){let i=a("div",[a("button","<"),a("span","TicTacToe")],"nav-bar");i.onclick=()=>{s.currentGameId=void 0,p()};let n;return(e.player1.email==m.email&&e.state==o.PLAYER1_TURN||e.player2.email==m.email&&e.state==o.PLAYER2_TURN)&&(n=r=>{console.log("should move",{gameid:e.id,fieldID:r});let d={action:{type:"move",gameId:e.id,field:r},player:_()};window.webxdc.sendUpdate({payload:d},"a game move")}),a("div",[i,a("div",[a("div",[a("div",[a("span",e.player1.name,"user circle")," vs ",a("span",e.player2.name,"user cross")],"game-title"),A({board:e.board,moveCallback:n}),a("div",a("div",P(e)),"turn-container")],"board-container")],"content")],"screen")}function Y(e){let{board:i,player1:n,player2:r}=e,d=a("div",[A({board:i,moveCallback:void 0}),a("div",[a("div",[a("span",n.name,"user circle")," vs ",a("span",r.name,"user cross")],"game-title"),a("div",a("div",P(e)),"turn-container")],"game-info")],"game-entry");return d.onclick=()=>{s.currentGameId=e.id,p()},d}function U({player1:e,gameId:i}){let n=e.email==m.email,r=a("div",n?[a("span","You","user circle")," started a game, waiting for someone to join..."]:s.wait_for_game_start_id==i?["asking ",a("span",e.name,"user circle")," to join their game, waiting for them to confirm..."]:[a("span",e.name,"user circle")," started a  game, tap this box to join"],"game-offer");return r.onclick=()=>{if(!n){if(!s.wait_for_game_start_id){s.wait_for_game_start_id=i;let d={action:{type:"join_request",gameId:i},player:_()};window.webxdc.sendUpdate({payload:d},"request to join a game")}p()}},r}function O(){let e=a("button","Create Game");return e.onclick=()=>{g(180,.1),j(),p()},e}function x({youHaveGameOffer:e}){let i=s.games.filter(({state:r})=>r==o.PLAYER1_TURN||r==o.PLAYER2_TURN),n=s.games.filter(({state:r})=>r!==o.PLAYER1_TURN&&r!==o.PLAYER2_TURN);return a("div",[a("div",a("span","TicTacToe"),"nav-bar"),a("div",[a("h2","Start a game"),e||O(),...s.gameOffers.map(U).reverse(),a("h2","Active Games"),...i.map(Y).reverse(),a("h2","Completed Games"),...n.map(Y).reverse()],"content")],"home-screen screen")}var h=document.getElementById("board-screen");function p(){let{youHaveGameOffer:e,currentGame:i}=k(),n;i?n=G(i):n=x({youHaveGameOffer:e}),h.innerHTML="",h.appendChild(n)}function _(){return{name:window.webxdc.selfName(),email:window.webxdc.selfAddr()}}var m=_(),o=Object.freeze({PLAYER1_TURN:1,PLAYER2_TURN:2,PLAYER1_WON:3,PLAYER2_WON:4,TIE:5}),s={currentGameId:void 0,gameOffers:[],games:[],wait_for_game_start_id:void 0};function k(){return{...s,youHaveGameOffer:s.gameOffers.findIndex(e=>e.player1.email==m.email)!==-1,currentGame:s.currentGameId?s.games.find(({id:e})=>e==s.currentGameId):void 0}}function j(){let e={action:{type:"create",gameId:Date.now()},player:_()};window.webxdc.sendUpdate({payload:e},"create a new game offer")}var f,R;function L(e,{payload:i}){let{action:n,player:r}=i,d=!1;try{if(!n){console.error("no action, ignoring state update");return}if(n.type=="create")s.gameOffers.push({player1:r,gameId:n.gameId,player2:void 0}),d=!0;else if(n.type=="join_request"){console.log("join_request recieved");let t=s.gameOffers.find(({gameId:l})=>l==n.gameId);if(t)t.player1.email==m.email&&(console.log("join_request is for my game"),(!f||f.id!=t.gameId)&&(f={id:t.gameId,player2:r},console.log("join_request accepted: ",{pending_game_start:f})));else throw new Error("Game offer for this join request doesn't exist")}else if(n.type=="start"){console.log("start a game");let t=s.gameOffers.find(({gameId:l})=>l==n.gameId);if(t)s.gameOffers=s.gameOffers.filter(l=>l!==t);else{console.error("game not found");return}f&&f.id==t.gameId&&(f=void 0),s.games.push({id:n.gameId,state:o.PLAYER1_TURN,player1:r,player2:n.player2,board:[0,0,0,0,0,0,0,0,0]}),console.log("started game",s.games[s.games.length-1]),(r.email==m.email||n.player2.email==m.email)&&(s.wait_for_game_start_id=void 0,e&&!s.currentGameId&&(g(180,.14),s.currentGameId=n.gameId)),d=!0}else if(n.type=="move"){let t=s.games.find(({id:l})=>l==n.gameId);if(!t)console.error("game for this action not found:",n.gameId,n);else{let l=r.email;if(t.player1.email!==l&&t.player2.email!==l){console.error("Player is not part of the game",{TurnPlayerEmail:l,game:t});return}let y=0;if(t.player1.email==l?y=1:t.player2.email==l&&(y=2),t.state==o.PLAYER2_TURN||t.state==o.PLAYER1_TURN){let T=function(E){let c=I=>t.board[I]===E;return c(0)&&c(1)&&c(2)||c(3)&&c(4)&&c(5)||c(6)&&c(7)&&c(8)||c(0)&&c(3)&&c(6)||c(1)&&c(4)&&c(7)||c(2)&&c(5)&&c(8)||c(0)&&c(4)&&c(8)||c(6)&&c(4)&&c(2)};var u=T;if(!(y===2&&t.state==o.PLAYER2_TURN||y===1&&t.state==o.PLAYER1_TURN)){console.error("not the turn of the player trying to make the move",{action:n,game:t});return}if(t.board[n.field]!==0){console.error("field is already taken",{action:n,game:t});return}t.board[n.field]=y,T(1)?t.state=o.PLAYER1_WON:T(2)?t.state=o.PLAYER2_WON:t.board.findIndex(E=>E===0)===-1?t.state=o.TIE:t.state=t.state==o.PLAYER1_TURN?o.PLAYER2_TURN:o.PLAYER1_TURN,d=!0,s.currentGameId===t.id&&(r.email===m.email?g(334):g(200),t.state==o.PLAYER1_WON||t.state==o.PLAYER2_WON?r.email===m.email&&(console.log("set pending_game_result_message",{action:n}),R="TicTacToe: "+r.name+" won against "+(r.email===t.player1.email?t.player2.name:t.player1.name)):t.state==o.TIE&&r.email===m.email&&(R="TicTacToe: The match between "+t.player1.name+" and "+t.player2.name+" resulted in a tie."),setTimeout(()=>{t.state==o.PLAYER1_WON||t.state==o.PLAYER2_WON?r.email===m.email?g(300,.4):g(190,.4):t.state==o.TIE&&g(195,.4)},210))}else{console.error("no players turn, are the turns received out of order?");return}}}else console.error("recieved unknown state update",{payload:i})}catch(t){console.error("error applying state update",t,{payload:i})}return d}document.onkeydown=e=>{(e.key=="Backspace"||e.key=="Escape")&&s.currentGameId&&(s.currentGameId=void 0,p())};p();window.webxdc.getAllUpdates().forEach(L.bind(null,!1));N();window.webxdc.setUpdateListener(e=>{L(!0,e)&&p(),N()});function N(){if(console.info("processPending"),f){let e={action:{type:"start",gameId:f.id,player2:f.player2},player:_()};window.webxdc.sendUpdate({payload:e,summary:b()},"start the game"),f=void 0}if(R){console.info("processPending:pending_game_result_message");let e=R;R=void 0,setTimeout(()=>window.webxdc.sendUpdate({payload:{},info:e,summary:b()},e),0)}}p();function b(){let e=s.games.filter(({state:d})=>d==o.PLAYER1_TURN||d==o.PLAYER2_TURN),i=s.games.filter(({state:d})=>d!==o.PLAYER1_TURN&&d!==o.PLAYER2_TURN),n=i.filter(({state:d})=>d===o.TIE).length,r=i.length-n;return`Stats:
Running Games: `+e.length+`
Completed Games: `+i.length+`
Wins: `+r+`
Ties: `+n}var w=new(window.AudioContext||window.webkitAudioContext),v=w.createGain();v.gain.value=.1;v.connect(w.destination);function g(e=440,i=.2){let n=w.createOscillator();n.connect(v),n.type="sawtooth",n.frequency.value=e,n.start(),n.stop(w.currentTime+i)}})();
